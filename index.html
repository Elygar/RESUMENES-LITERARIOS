<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RES√öMENES LITERARIOS - Audiolibros y Res√∫menes</title>
  <meta name="description" content="Colecci√≥n de res√∫menes en video y audiolibros organizados por g√©nero. Reproduce, explora y descubre obras literarias." />
  <link rel="icon" href="favicon.ico" />

  <style>
    :root{--primary:#5e35b1;--dark:#311b92;}
    *{box-sizing:border-box;}
    body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;margin:0;background:#f4f1fa;color:#333;display:flex;flex-direction:column;min-height:100vh}
    header{background:linear-gradient(90deg,var(--primary),var(--dark));color:#fff;padding:18px;text-align:center;position:relative}
    header h1{margin:0;font-size:1.6rem}
    .menu-btn{position:absolute;left:14px;top:10px;cursor:pointer;width:44px;height:44px}
    .menu-btn img{width:100%;height:100%;object-fit:contain}
    .search-container{display:flex;justify-content:center;align-items:center;gap:10px;padding:14px;flex-wrap:wrap}
    .search-container input{width:100%;max-width:420px;padding:10px 14px;border-radius:22px;border:1px solid #ccc;font-size:14px;min-width:200px}
    .search-container button{padding:10px 16px;border-radius:22px;border:none;background:var(--primary);color:#fff;cursor:pointer;white-space:nowrap}
    .search-container button:disabled{opacity:.6;cursor:not-allowed}
    main{flex:1;width:100%}
    .wrap{max-width:1200px;margin:0 auto;padding:10px;width:100%}
    .content{display:grid;grid-template-columns:1fr;gap:10px}
    .video-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px;padding:18px}
    .card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.08);transition:transform .18s}
    .card:hover{transform:translateY(-6px)}
    .card img{width:100%;height:206px;object-fit:cover;display:block}
    .card .card-content{padding:12px}
    .card h3{margin:0;font-size:1rem;color:var(--dark);word-wrap:break-word}
    .card p{margin:6px 0;font-size:.9rem;color:#333;word-wrap:break-word}
    .btn{display:inline-block;padding:8px 14px;border-radius:18px;border:none;background:var(--primary);color:#fff;cursor:pointer}
    .btn.secondary{background:#666}
    .pagination{display:flex;gap:8px;justify-content:center;align-items:center;padding:12px;flex-wrap:wrap}
    .pagination button{padding:8px 12px;border-radius:18px;border:none;background:var(--primary);color:#fff;cursor:pointer;font-size:14px}
    .pagination button:disabled{background:#bdbdbd;cursor:not-allowed}
    .page-info{font-size:.95rem;color:#444;margin:0 8px}
    #noResults{display:none;text-align:center;padding:40px;color:#666;font-size:1.1rem}
    
    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:2000;align-items:center;justify-content:center;padding:20px;overflow-y:auto}
    .overlay .box{width:100%;max-width:980px;background:#111;border-radius:12px;overflow:hidden;color:#fff;margin:auto;position:relative}
    .overlay iframe{width:100%;height:480px;border:0;display:block}
    .close-btn{position:absolute;right:10px;top:10px;background:crimson;color:white;border:none;border-radius:50%;width:36px;height:36px;cursor:pointer;z-index:2200;font-size:18px}
    .video-info{padding:18px;background:#111;border-bottom:1px solid #222}
    .video-info .header-row{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:8px}
    .video-info h2{margin:0;font-size:1.4rem;word-wrap:break-word;flex:1}
    
    /* Sistema de calificaci√≥n con estrellas */
    .rating-container{display:flex;align-items:center;gap:12px;margin-top:8px;flex-wrap:wrap}
    .stars-display{display:flex;gap:3px;align-items:center}
    .star{font-size:20px;color:#ffd700}
    .star.empty{color:#444}
    .rating-text{color:#aaa;font-size:.9rem}
    .rate-btn{padding:6px 14px;background:var(--primary);color:#fff;border:none;border-radius:16px;cursor:pointer;font-size:.85rem;transition:background .3s}
    .rate-btn:hover{background:var(--dark)}
    .rate-stars{display:none;gap:5px;align-items:center}
    .rate-stars.show{display:flex}
    .rate-star{font-size:28px;color:#444;cursor:pointer;transition:all .2s;user-select:none}
    .rate-star:hover,
    .rate-star.hover{color:#ffd700;transform:scale(1.2)}
    .rating-message{color:#4caf50;font-size:.85rem;margin-left:10px;display:none}
    .rating-message.show{display:inline}
    
    .share-buttons{display:flex;gap:8px;flex-shrink:0}
    .share-btn{width:36px;height:36px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .2s}
    .share-btn:hover{transform:scale(1.1)}
    .share-btn.facebook{background:#1877f2}
    .share-btn.whatsapp{background:#25d366}
    .share-btn svg{width:20px;height:20px;fill:#fff}
    .video-info .author{color:#bbb;margin-bottom:8px}
    .video-info .synopsis{color:#ddd;line-height:1.5;word-wrap:break-word}
    .video-tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .video-tag{background:var(--primary);padding:6px 10px;border-radius:14px;font-size:.85rem;cursor:pointer;border:none;color:#fff}
    .related-videos{padding:16px;background:#0f0f0f}
    .related-videos h3{margin:0 0 10px;font-size:1.2rem}
    .related-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
    .related-card{display:block;background:#222;border-radius:8px;overflow:hidden;cursor:pointer;color:#fff;text-decoration:none}
    .related-card img{width:100%;height:90px;object-fit:cover;display:block}
    .related-card .meta{padding:8px;font-size:.9rem;color:#ddd;word-wrap:break-word}
    .report-btn{width:100%;padding:12px;background:#ff4444;color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;margin-top:16px;transition:background .3s;display:flex;align-items:center;justify-content:center;gap:8px}
    .report-btn:hover{background:#cc0000}
    
    .sidebar{position:fixed;left:-300px;top:0;height:100%;width:260px;background:var(--dark);color:#fff;padding:18px;transition:left .25s;z-index:2100;overflow:auto}
    .sidebar.active{left:0}
    .sidebar h3{text-align:center;margin:0 0 12px;font-size:1.2rem}
    .genre-tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .genre-tag{border:1px solid rgba(255,255,255,.2);padding:8px 10px;border-radius:12px;cursor:pointer;font-size:.85rem;text-transform:uppercase;background:transparent;color:#fff}
    .genre-tag.active{background:#fff;color:var(--dark);border-color:#fff}
    .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:2050}
    .sidebar-overlay.show{display:block}
    
    .contact-btn{width:100%;padding:12px;background:#ff6b35;color:#fff;border:none;border-radius:12px;font-size:1rem;font-weight:bold;cursor:pointer;margin-top:20px;transition:background .3s}
    .contact-btn:hover{background:#ff8555}
    
    .contact-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:3000;align-items:center;justify-content:center;padding:20px}
    .contact-overlay.show{display:flex}
    .contact-modal{background:#fff;border-radius:16px;width:100%;max-width:500px;position:relative;box-shadow:0 10px 40px rgba(0,0,0,.3)}
    .contact-header{background:linear-gradient(135deg,var(--primary),var(--dark));color:#fff;padding:20px;border-radius:16px 16px 0 0;text-align:center;position:relative}
    .contact-header h2{margin:0;font-size:1.5rem}
    .contact-close{position:absolute;right:15px;top:15px;background:rgba(255,255,255,.2);color:#fff;border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;font-size:20px;transition:background .3s}
    .contact-close:hover{background:rgba(255,255,255,.3)}
    .contact-body{padding:25px}
    .form-group{margin-bottom:18px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600;color:#333;font-size:.95rem}
    .form-group input,
    .form-group textarea{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:.95rem;font-family:inherit;transition:border-color .3s}
    .form-group input:focus,
    .form-group textarea:focus{outline:none;border-color:var(--primary)}
    .form-group textarea{resize:vertical;min-height:120px}
    .form-submit{width:100%;padding:14px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-size:1.1rem;font-weight:bold;cursor:pointer;transition:background .3s}
    .form-submit:hover{background:var(--dark)}
    .form-submit:disabled{background:#bdbdbd;cursor:not-allowed}
    .form-message{margin-top:15px;padding:12px;border-radius:8px;text-align:center;font-weight:600;display:none}
    .form-message.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .form-message.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .form-message.show{display:block}
    
    footer{background:var(--dark);color:#fff;text-align:center;padding:12px;font-size:14px}

    @media(max-width:768px){
      header h1{font-size:1.3rem;padding-right:50px}
      .search-container{padding:10px}
      .search-container input{width:calc(100% - 100px);min-width:150px}
      .video-list{grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;padding:12px}
      .overlay .box{margin:10px;max-height:95vh;overflow-y:auto}
      .overlay iframe{height:260px}
      .video-info{padding:14px}
      .video-info .header-row{flex-direction:column;align-items:flex-start}
      .video-info h2{font-size:1.2rem}
      .share-buttons{margin-top:8px}
      .rating-container{gap:8px}
      .star{font-size:18px}
      .rate-star{font-size:24px}
      .related-grid{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
      .pagination{gap:6px;padding:10px}
      .pagination button{padding:6px 10px;font-size:13px}
      .page-info{font-size:.85rem}
      .close-btn{right:8px;top:8px;width:32px;height:32px;font-size:16px}
      .contact-modal{margin:10px}
      .contact-header h2{font-size:1.3rem}
      .contact-body{padding:20px}
      .report-btn{font-size:.95rem;padding:10px}
    }

    @media(max-width:480px){
      header h1{font-size:1.1rem;text-align:right}
      .search-container input{width:calc(100% - 90px);font-size:13px}
      .search-container button{padding:8px 12px;font-size:13px}
      .video-list{grid-template-columns:1fr;padding:10px}
      .card img{height:165px}
      .overlay iframe{height:220px}
      .video-info h2{font-size:1.1rem}
      .share-btn{width:32px;height:32px}
      .share-btn svg{width:18px;height:18px}
      .rating-container{flex-direction:column;align-items:flex-start;gap:6px}
      .star{font-size:16px}
      .rate-star{font-size:22px}
      .related-grid{grid-template-columns:repeat(2,1fr);gap:8px}
      .pagination button{padding:6px 8px;font-size:12px}
      .sidebar{width:240px;left:-240px}
      .contact-modal{max-width:100%;margin:0}
      .contact-header{padding:15px}
      .contact-body{padding:15px}
      .report-btn{font-size:.9rem;padding:10px}
    }

    @media(min-width:1400px){
      .video-list{grid-template-columns:repeat(auto-fill,minmax(300px,1fr))}
    }
  </style>
</head>
<body>

  <header>
    <h1>RES√öMENES LITERARIOS</h1>
    <div class="menu-btn" id="menuBtn" onclick="toggleMenu()">
      <img src="favicon.png" alt="Men√∫">
    </div>
  </header>

  <div class="sidebar" id="sidebar" aria-hidden="true">
    <h3>G√âNEROS</h3>
    <div id="genreList" class="genre-tags" aria-label="Lista de g√©neros"></div>
    <button class="contact-btn" onclick="openContactForm()">‚úâÔ∏è ESCR√çBENOS</button>
  </div>
  <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleMenu()"></div>

  <main>
    <div class="wrap">
      <div class="search-container" role="search">
        <input id="searchInput" type="text" placeholder="Buscar por t√≠tulo, autor o sinopsis..." aria-label="Buscar">
        <button id="searchBtn" onclick="buscar()">Buscar</button>
      </div>

      <div id="noResults">P√°gina no encontrada.</div>

      <section class="video-list" id="videoList" aria-live="polite"></section>

      <div class="pagination" id="paginationBar" role="navigation" aria-label="Paginaci√≥n"></div>
    </div>
  </main>

  <div class="overlay" id="videoOverlay" role="dialog" aria-modal="true" onclick="closeOverlayOnBackground(event)">
    <div class="box" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeOverlay()">‚úñ</button>
      <div id="playerWrap">
        <iframe id="playerFrame" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
      </div>
      <div class="video-info" id="videoInfo"></div>
      <div class="related-videos" id="relatedVideos"></div>
    </div>
  </div>

  <div class="contact-overlay" id="contactOverlay" onclick="closeContactOnBackground(event)">
    <div class="contact-modal" onclick="event.stopPropagation()">
      <div class="contact-header">
        <h2>üì¨ Cont√°ctanos</h2>
        <button class="contact-close" onclick="closeContactForm()">√ó</button>
      </div>
      <div class="contact-body">
        <form id="contactForm">
          <div class="form-group">
            <label for="nombreInput">Nombre *</label>
            <input type="text" id="nombreInput" name="nombre" required placeholder="Tu nombre completo">
          </div>
          <div class="form-group">
            <label for="correoInput">Correo electr√≥nico *</label>
            <input type="email" id="correoInput" name="correo" required placeholder="tu@email.com">
          </div>
          <div class="form-group">
            <label for="mensajeInput">Mensaje *</label>
            <textarea id="mensajeInput" name="mensaje" required placeholder="Solicita un resumen, reporta un problema o d√©janos tus comentarios..."></textarea>
          </div>
          <button type="submit" class="form-submit" id="submitBtn">Enviar mensaje</button>
          <div class="form-message" id="formMessage"></div>
        </form>
      </div>
    </div>
  </div>

  <footer><small>&copy; 2025 Audiolibros - Res√∫menes en Video de Obras Literarias</small></footer>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyAY2WuwPBjHDyzkDXXXhvwu3Inu3Ctl2eQ",
    authDomain: "resumenes-literarios2.firebaseapp.com",
    projectId: "resumenes-literarios2",
    storageBucket: "resumenes-literarios2.firebasestorage.app",
    messagingSenderId: "696816328291",
    appId: "1:696816328291:web:70541497c1fdc76302e256"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.enviarFormulario = async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const formMessage = document.getElementById('formMessage');
    const nombre = document.getElementById('nombreInput').value.trim();
    const correo = document.getElementById('correoInput').value.trim();
    const mensaje = document.getElementById('mensajeInput').value.trim();

    if (!nombre || !correo || !mensaje) {
      mostrarMensaje('Por favor completa todos los campos', 'error');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando...';
    formMessage.classList.remove('show');

    try {
      await addDoc(collection(db, 'mensajes'), {
        nombre: nombre,
        correo: correo,
        mensaje: mensaje,
        fecha: serverTimestamp()
      });

      mostrarMensaje('‚úÖ ¬°Mensaje enviado correctamente! Te responderemos pronto.', 'success');
      document.getElementById('contactForm').reset();
      
      setTimeout(() => {
        closeContactForm();
      }, 2500);

    } catch (error) {
      console.error('Error:', error);
      mostrarMensaje('‚ùå Error al enviar el mensaje. Intenta nuevamente.', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Enviar mensaje';
    }
  };

  function mostrarMensaje(texto, tipo) {
    const formMessage = document.getElementById('formMessage');
    formMessage.textContent = texto;
    formMessage.className = `form-message ${tipo} show`;
  }

  window.obtenerCalificacion = async function(videoId) {
    try {
      const docRef = doc(db, 'calificaciones', videoId);
      const docSnap = await getDoc(docRef);
      
      if (docSnap.exists()) {
        const data = docSnap.data();
        return {
          promedio: data.promedio || 0,
          total: data.total || 0
        };
      }
      return { promedio: 0, total: 0 };
    } catch (error) {
      console.error('Error obteniendo calificaci√≥n:', error);
      return { promedio: 0, total: 0 };
    }
  };

  window.calificarVideo = async function(videoId, estrellas) {
    try {
      const docRef = doc(db, 'calificaciones', videoId);
      const docSnap = await getDoc(docRef);
      
      if (docSnap.exists()) {
        const data = docSnap.data();
        const nuevoTotal = (data.total || 0) + 1;
        const nuevaSuma = (data.suma || 0) + estrellas;
        const nuevoPromedio = nuevaSuma / nuevoTotal;
        
        await updateDoc(docRef, {
          total: nuevoTotal,
          suma: nuevaSuma,
          promedio: parseFloat(nuevoPromedio.toFixed(1))
        });
      } else {
        await setDoc(docRef, {
          total: 1,
          suma: estrellas,
          promedio: estrellas
        });
      }
      
      return true;
    } catch (error) {
      console.error('Error al calificar:', error);
      return false;
    }
  };

  document.getElementById('contactForm').addEventListener('submit', window.enviarFormulario);
</script>

<script>
let videos = [];
let listaActual = [];
let currentPage = 1;
const itemsPerPage = 12;

fetch('videos.json?t=' + Date.now())
  .then(r => r.json())
  .then(data => {
    videos = Array.isArray(data) ? data : [];
    listaActual = videos.slice();
    cargarGeneros();
    mostrarPagina(1);
  })
  .catch(err => {
    console.error('Error cargando videos.json', err);
    document.getElementById('noResults').textContent = 'Error cargando contenido.';
    document.getElementById('noResults').style.display = 'block';
  });

function mostrarPagina(page){
  const listEl = document.getElementById('videoList');
  const noResEl = document.getElementById('noResults');
  listEl.innerHTML = '';
  noResEl.style.display = 'none';

  if (!Array.isArray(listaActual) || listaActual.length === 0) {
    noResEl.style.display = 'block';
    renderPaginacion(0);
    return;
  }

  const totalPages = Math.max(1, Math.ceil(listaActual.length / itemsPerPage));
  if (page < 1) page = 1;
  if (page > totalPages) page = totalPages;
  currentPage = page;

  const start = (currentPage - 1) * itemsPerPage;
  const slice = listaActual.slice(start, start + itemsPerPage);

  const frag = document.createDocumentFragment();
  slice.forEach(v => {
    const art = document.createElement('article');
    art.className = 'card';
    art.innerHTML = `
      <img loading="lazy" src="https://img.youtube.com/vi/${v.id}/hqdefault.jpg" alt="${escapeHtml(v.titulo)}">
      <div class="card-content">
        <h3>${escapeHtml(v.titulo)}</h3>
        <p><strong>Autor:</strong> ${escapeHtml(v.autor)}</p>
        <p title="${escapeHtml(v.sinopsis)}">${escapeHtml(truncate(v.sinopsis,120))}</p>
        <button class="btn" onclick="openOverlay('${v.id}')">Ver m√°s</button>
      </div>`;
    frag.appendChild(art);
  });
  listEl.appendChild(frag);
  renderPaginacion(Math.ceil(listaActual.length / itemsPerPage));
  window.scrollTo({top:0, behavior:'smooth'});
}

function renderPaginacion(totalPages) {
  const p = document.getElementById('paginationBar');
  p.innerHTML = '';
  if (totalPages === 0) return;

  const btnInicio = document.createElement('button');
  btnInicio.textContent = 'Inicio';
  btnInicio.disabled = currentPage === 1;
  btnInicio.onclick = () => mostrarPagina(1);
  p.appendChild(btnInicio);

  const btnPrev = document.createElement('button');
  btnPrev.textContent = 'Anterior';
  btnPrev.disabled = currentPage === 1;
  btnPrev.onclick = () => mostrarPagina(currentPage - 1);
  p.appendChild(btnPrev);

  const info = document.createElement('span');
  info.className = 'page-info';
  info.textContent = `P√°gina ${currentPage} de ${totalPages}`;
  p.appendChild(info);

  const btnNext = document.createElement('button');
  btnNext.textContent = 'Siguiente';
  btnNext.disabled = currentPage === totalPages;
  btnNext.onclick = () => mostrarPagina(currentPage + 1);
  p.appendChild(btnNext);
}

document.getElementById('searchInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    buscar();
  }
});

function buscar(){
  const texto = document.getElementById('searchInput').value.toLowerCase().trim();
  if (!texto){
    listaActual = videos.slice();
    mostrarPagina(1);
    return;
  }
  listaActual = videos.filter(v => 
    (v.titulo && v.titulo.toLowerCase().includes(texto)) ||
    (v.autor && v.autor.toLowerCase().includes(texto)) ||
    (v.sinopsis && v.sinopsis.toLowerCase().includes(texto)) ||
    (v.genero && v.genero.toLowerCase().includes(texto))
  );
  mostrarPagina(1);
}

function cargarGeneros(){
  const cont = document.getElementById('genreList');
  cont.innerHTML = '';

  const setG = new Set();
  videos.forEach(v => {
    if (!v.genero) return;
    v.genero.split(',').forEach(g => {
      const gg = g.trim();
      if (gg) setG.add(gg);
    });
  });

  const todos = document.createElement('div');
  todos.className = 'genre-tag active';
  todos.textContent = 'TODOS';
  todos.onclick = () => {
    document.querySelectorAll('.genre-tag').forEach(t=>t.classList.remove('active'));
    todos.classList.add('active');
    listaActual = videos.slice();
    mostrarPagina(1);
    if (window.innerWidth <= 768) toggleMenu();
  };
  cont.appendChild(todos);

  [...setG].sort((a,b)=>a.localeCompare(b,'es')).forEach(g => {
    const el = document.createElement('div');
    el.className = 'genre-tag';
    el.textContent = g;
    el.onclick = () => {
      document.querySelectorAll('.genre-tag').forEach(t=>t.classList.remove('active'));
      el.classList.add('active');
      const key = g.toLowerCase();
      listaActual = videos.filter(v => v.genero && v.genero.toLowerCase().includes(key));
      mostrarPagina(1);
      if (window.innerWidth <= 768) toggleMenu();
    };
    cont.appendChild(el);
  });
}

async function openOverlay(videoId){
  const v = videos.find(x => x.id === videoId);
  if (!v) return;
  const overlay = document.getElementById('videoOverlay');
  const iframe = document.getElementById('playerFrame');
  iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
  overlay.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  await mostrarInfoVideo(v);
  mostrarVideosRelacionados(v);
}

function closeOverlay(){
  document.getElementById('videoOverlay').style.display = 'none';
  document.body.style.overflow = '';
  const iframe = document.getElementById('playerFrame');
  iframe.src = '';
  document.getElementById('videoInfo').innerHTML = '';
  document.getElementById('relatedVideos').innerHTML = '';
}

function closeOverlayOnBackground(e){
  if(e.target.id === 'videoOverlay') closeOverlay();
}

async function mostrarInfoVideo(video){
  const cont = document.getElementById('videoInfo');
  const generos = (video.genero || '').split(',').map(s=>s.trim()).filter(Boolean);
  const tagsHtml = generos.map(g => `<button class="video-tag" onclick="filterFromTag('${escapeJs(g)}')">${escapeHtml(g)}</button>`).join(' ');
  
  const videoUrl = `https://www.youtube.com/watch?v=${video.id}`;
  const shareText = `${video.titulo} - ${video.autor}`;
  
  // Obtener calificaci√≥n actual
  const rating = await obtenerCalificacion(video.id);
  const ratingHtml = generarEstrellas(rating.promedio, rating.total);
  
  cont.innerHTML = `
    <div class="header-row">
      <div style="flex:1">
        <h2>${escapeHtml(video.titulo)}</h2>
        <div class="rating-container" id="ratingContainer-${video.id}">
          ${ratingHtml}
          <button class="rate-btn" onclick="mostrarCalificar('${video.id}')">Calificar</button>
          <div class="rate-stars" id="rateStars-${video.id}">
            ${[1,2,3,4,5].map(n => `<span class="rate-star" onmouseover="hoverStar(${n}, '${video.id}')" onmouseout="resetStars('${video.id}')" onclick="enviarCalificacion('${video.id}', ${n})">‚òÖ</span>`).join('')}
            <span class="rating-message" id="ratingMsg-${video.id}">¬°Gracias por calificar!</span>
          </div>
        </div>
      </div>
      <div class="share-buttons">
        <button class="share-btn facebook" onclick="compartirFacebook('${escapeJs(videoUrl)}')" title="Compartir en Facebook">
          <svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
        </button>
        <button class="share-btn whatsapp" onclick="compartirWhatsApp('${escapeJs(shareText)}','${escapeJs(videoUrl)}')" title="Compartir en WhatsApp">
          <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
        </button>
      </div>
    </div>
    <div class="author"><strong>Autor:</strong> ${escapeHtml(video.autor)}</div>
    <div class="synopsis">${escapeHtml(video.sinopsis)}</div>
    <div class="video-tags">${tagsHtml}</div>
  `;
}

function generarEstrellas(promedio, total) {
  const estrellas = [];
  for (let i = 1; i <= 5; i++) {
    if (i <= Math.round(promedio)) {
      estrellas.push('<span class="star">‚òÖ</span>');
    } else {
      estrellas.push('<span class="star empty">‚òÖ</span>');
    }
  }
  const textoRating = total > 0 ? `${promedio.toFixed(1)} (${total} ${total === 1 ? 'voto' : 'votos'})` : 'Sin calificaciones';
  return `
    <div class="stars-display">
      ${estrellas.join('')}
    </div>
    <span class="rating-text">${textoRating}</span>
  `;
}

function mostrarCalificar(videoId) {
  const btn = document.querySelector(`#ratingContainer-${videoId} .rate-btn`);
  const stars = document.getElementById(`rateStars-${videoId}`);
  if (btn && stars) {
    btn.style.display = 'none';
    stars.classList.add('show');
  }
}

function hoverStar(n, videoId) {
  const stars = document.querySelectorAll(`#rateStars-${videoId} .rate-star`);
  stars.forEach((star, i) => {
    if (i < n) {
      star.classList.add('hover');
    } else {
      star.classList.remove('hover');
    }
  });
}

function resetStars(videoId) {
  const stars = document.querySelectorAll(`#rateStars-${videoId} .rate-star`);
  stars.forEach(star => star.classList.remove('hover'));
}

async function enviarCalificacion(videoId, estrellas) {
  const success = await calificarVideo(videoId, estrellas);
  
  if (success) {
    const msg = document.getElementById(`ratingMsg-${videoId}`);
    const starsDiv = document.getElementById(`rateStars-${videoId}`);
    
    if (msg) {
      msg.classList.add('show');
      setTimeout(() => {
        msg.classList.remove('show');
      }, 3000);
    }
    
    // Actualizar la visualizaci√≥n de estrellas
    const rating = await obtenerCalificacion(videoId);
    const container = document.getElementById(`ratingContainer-${videoId}`);
    if (container) {
      const ratingHtml = generarEstrellas(rating.promedio, rating.total);
      container.innerHTML = `
        ${ratingHtml}
        <button class="rate-btn" onclick="mostrarCalificar('${videoId}')">Calificar</button>
        <div class="rate-stars" id="rateStars-${videoId}">
          ${[1,2,3,4,5].map(n => `<span class="rate-star" onmouseover="hoverStar(${n}, '${videoId}')" onmouseout="resetStars('${videoId}')" onclick="enviarCalificacion('${videoId}', ${n})">‚òÖ</span>`).join('')}
          <span class="rating-message" id="ratingMsg-${videoId}">¬°Gracias por calificar!</span>
        </div>
      `;
    }
  } else {
    alert('Error al enviar la calificaci√≥n. Intenta nuevamente.');
  }
}

function filterFromTag(g){
  closeOverlay();
  const el = [...document.querySelectorAll('.genre-tag')].find(x => x.textContent.toLowerCase() === g.toLowerCase());
  if (el){
    el.click();
  } else {
    listaActual = videos.filter(v => v.genero && v.genero.toLowerCase().includes(g.toLowerCase()));
    document.querySelectorAll('.genre-tag').forEach(t=>t.classList.remove('active'));
    mostrarPagina(1);
  }
}

function mostrarVideosRelacionados(videoActual){
  const container = document.getElementById('relatedVideos');
  container.innerHTML = '';
  const genAct = (videoActual.genero || '').toLowerCase().split(',').map(s=>s.trim()).filter(Boolean);
  let relacionados = videos.filter(v => {
    if (v.id === videoActual.id) return false;
    const genV = (v.genero || '').toLowerCase().split(',').map(s=>s.trim());
    return genAct.some(g => genV.includes(g));
  });

  if (relacionados.length < 4) {
    const otros = videos.filter(v => v.id !== videoActual.id && !relacionados.includes(v));
    relacionados = relacionados.concat(otros);
  }

  relacionados = relacionados.sort(()=>Math.random()-0.5).slice(0,4);

  if (relacionados.length === 0) return;
  const title = document.createElement('h3');
  title.textContent = 'Videos Relacionados';
  const grid = document.createElement('div');
  grid.className = 'related-grid';

  relacionados.forEach(rv => {
    const card = document.createElement('a');
    card.className = 'related-card';
    card.onclick = (e) => { e.preventDefault(); openOverlay(rv.id); };
    card.innerHTML = `
      <img src="https://img.youtube.com/vi/${rv.id}/hqdefault.jpg" alt="${escapeHtml(rv.titulo)}">
      <div class="meta"><strong>${escapeHtml(rv.titulo)}</strong><div style="color:#aaa;font-size:.85rem">${escapeHtml(rv.autor)}</div></div>
    `;
    grid.appendChild(card);
  });

  container.appendChild(title);
  container.appendChild(grid);
  
  const reportBtn = document.createElement('button');
  reportBtn.className = 'report-btn';
  reportBtn.innerHTML = '‚ö†Ô∏è Reportar un problema';
  reportBtn.onclick = () => {
    openContactForm();
    setTimeout(() => {
      const mensajeInput = document.getElementById('mensajeInput');
      mensajeInput.value = `Reporte sobre: ${videoActual.titulo}\n\nDescribe el problema:\n`;
      mensajeInput.focus();
    }, 100);
  };
  container.appendChild(reportBtn);
}

function toggleMenu(){
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  const isActive = sidebar.classList.toggle('active');
  overlay.classList.toggle('show', isActive);
  if(isActive) document.body.style.overflow = 'hidden';
  else document.body.style.overflow = '';
}

function openContactForm(){
  document.getElementById('contactOverlay').classList.add('show');
  document.body.style.overflow = 'hidden';
  if (window.innerWidth <= 768) toggleMenu();
}

function closeContactForm(){
  document.getElementById('contactOverlay').classList.remove('show');
  document.body.style.overflow = '';
  document.getElementById('contactForm').reset();
  document.getElementById('formMessage').classList.remove('show');
}

function closeContactOnBackground(e){
  if(e.target.id === 'contactOverlay') closeContactForm();
}

function compartirFacebook(url){
  window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank', 'width=600,height=400');
}

function compartirWhatsApp(text, url){
  const mensaje = `${text}\n${url}`;
  window.open(`https://wa.me/?text=${encodeURIComponent(mensaje)}`, '_blank');
}

function escapeHtml(str = '') {
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}
function escapeJs(str=''){ return String(str).replace(/'/g,"\\'"); }
function truncate(s, n=120){ return s && s.length>n ? s.slice(0,n-1)+'‚Ä¶' : (s||''); }
</script>
</body>
</html>
